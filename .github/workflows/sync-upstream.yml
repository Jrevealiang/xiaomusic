name: Sync upstream repository and push to Gitee

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©UTCæ—¶é—´00:00ï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰åŒæ­¥ä¸€æ¬¡
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼šåœ¨GitHubé¡µé¢ä¸Šæ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  
  # å½“ä¸Šæ¸¸ä»“åº“æœ‰pushäº‹ä»¶æ—¶è§¦å‘ï¼ˆéœ€è¦é…ç½®webhookï¼Œå¯é€‰ï¼‰
  # repository_dispatch:
  #   types: [upstream-updated]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºæ‚¨çš„ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      # 3. æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶åŒæ­¥
      - name: Sync from upstream
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/hanxi/xiaomusic.git || true
          
          # è·å–ä¸Šæ¸¸ä»“åº“æ›´æ–°
          git fetch upstream
          
          # åˆ‡æ¢åˆ°ä¸»åˆ†æ”¯ï¼ˆæ ¹æ®å®é™…æƒ…å†µå¯èƒ½æ˜¯mainæˆ–masterï¼‰
          git checkout main 2>/dev/null || git checkout master
          
          # è·å–å½“å‰åˆ†æ”¯å
          CURRENT_BRANCH=$(git branch --show-current)
          
          # åˆå¹¶ä¸Šæ¸¸æ›´æ”¹
          git merge upstream/$CURRENT_BRANCH --no-edit
          
          # æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶å†²çª
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "âš ï¸  Merge conflicts detected! Please resolve manually."
            echo "Conflicting files:"
            git diff --name-only --diff-filter=U
            # ç»§ç»­æ‰§è¡Œï¼Œä½†è®°å½•å†²çª
          fi
      
      # 4. æ¨é€åˆ°GitHubä»“åº“ï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æ¨é€ï¼‰
      - name: Push to GitHub
        run: |
          # è·å–å½“å‰åˆ†æ”¯å
          CURRENT_BRANCH=$(git branch --show-current)
          
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ¨é€çš„æ›´æ”¹
          if git status --porcelain | grep -q . || git log origin/$CURRENT_BRANCH..$CURRENT_BRANCH | grep -q .; then
            echo "ğŸ”„ Pushing changes to GitHub..."
            git push origin $CURRENT_BRANCH
            echo "âœ… Successfully pushed to GitHub"
          else
            echo "â„¹ï¸  No changes to push to GitHub"
          fi
      
      # 5. æ¨é€åˆ°Giteeä»“åº“ï¼ˆä½¿ç”¨HTTP+Tokenæ–¹å¼ï¼‰
      - name: Push to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          # è·å–å½“å‰åˆ†æ”¯å
          CURRENT_BRANCH=$(git branch --show-current)
          
          # éªŒè¯GITEE_TOKENæ˜¯å¦å­˜åœ¨
          if [ -z "$GITEE_TOKEN" ]; then
            echo "âŒ GITEE_TOKEN is not set. Please add it to GitHub Secrets."
            exit 1
          fi
          
          # æ„å»ºGiteeè¿œç¨‹URLï¼ˆä½¿ç”¨Tokenè®¤è¯ï¼‰
          GITEE_URL="https://oauth2:${GITEE_TOKEN}@git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          echo "ğŸ”— Gitee URL: https://oauth2:***@git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          # æ·»åŠ æˆ–æ›´æ–°Giteeè¿œç¨‹ä»“åº“
          git remote add gitee "$GITEE_URL" 2>/dev/null || true
          git remote set-url gitee "$GITEE_URL"
          
          echo "ğŸ”„ Pushing to Gitee (branch: $CURRENT_BRANCH)..."
          
          # æµ‹è¯•Giteeè¿æ¥ï¼ˆå¯é€‰ï¼‰
          echo "Testing connection to Gitee..."
          git ls-remote "$GITEE_URL" --heads "$CURRENT_BRANCH" 2>/dev/null && echo "âœ… Gitee connection successful" || echo "âš ï¸  Gitee connection test failed, but continuing..."
          
          # æ¨é€åˆ°Giteeï¼ˆå¼ºåˆ¶æ¨é€ç¡®ä¿ä¸€è‡´æ€§ï¼‰
          if git push gitee "$CURRENT_BRANCH" --force; then
            echo "âœ… Successfully pushed to Gitee"
          else
            echo "âŒ Failed to push to Gitee. Trying with more details..."
            
            # å°è¯•ä½¿ç”¨è¯¦ç»†è¾“å‡º
            git push gitee "$CURRENT_BRANCH" --force --verbose
            
            # æ£€æŸ¥å¯èƒ½çš„é—®é¢˜
            echo "Checking remote configuration..."
            git remote -v
            
            echo "Checking branch information..."
            git branch -a
            
            exit 1
          fi
      
      # 6. æ¸…ç†å’Œæ€»ç»“
      - name: Cleanup and summary
        run: |
          echo "========================================"
          echo "ğŸ‰ Sync completed successfully!"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸŒ GitHub: https://github.com/Jrevealiang/xiaomusic"
          echo "ğŸ  Gitee: https://git.jrevea.cn:88/liang/xiaomusic_github"
          echo "========================================"
