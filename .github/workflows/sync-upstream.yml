name: Sync upstream repository and push to Gitee

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Ê£ÄÂá∫ÊÇ®ÁöÑ‰ªìÂ∫ì
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. ÈÖçÁΩÆGitÁî®Êà∑‰ø°ÊÅØ
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      # 3. Ê∑ªÂä†‰∏äÊ∏∏‰ªìÂ∫ìÂπ∂ÂêåÊ≠•
      - name: Sync from upstream
        run: |
          git remote add upstream https://github.com/hanxi/xiaomusic.git || true
          git fetch upstream
          git checkout main 2>/dev/null || git checkout master
          CURRENT_BRANCH=$(git branch --show-current)
          git merge upstream/$CURRENT_BRANCH --no-edit
      
      # 4. Êé®ÈÄÅÂà∞GitHub
      - name: Push to GitHub
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          if git status --porcelain | grep -q . || git log origin/$CURRENT_BRANCH..$CURRENT_BRANCH | grep -q .; then
            echo "üîÑ Pushing changes to GitHub..."
            git push origin $CURRENT_BRANCH
          fi
      
      # 5. ÈÖçÁΩÆGiteeÊé®ÈÄÅÔºà‰ΩøÁî®write:repositoryÊùÉÈôêÔºâ
      - name: Configure and push to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          echo "=== Configuring Gitee Push ==="
          
          # È™åËØÅ‰ª§Áâå
          if [ -z "$GITEE_TOKEN" ]; then
            echo "‚ùå ERROR: GITEE_TOKEN is not set!"
            exit 1
          fi
          
          echo "‚úÖ GITEE_TOKEN is available"
          echo "Token permissions: write:repository (confirmed)"
          
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          
          # ÊñπÊ≥ï1ÔºöÁõ¥Êé•‰ΩøÁî®‰ª§ÁâåÔºàGitea/GiteeÂ∏∏Áî®Ê†ºÂºèÔºâ
          echo ""
          echo "Trying Method 1: Direct token usage..."
          GITEE_URL="https://$GITEE_TOKEN@git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          # Ê∏ÖÁêÜÊóßÁöÑremote
          git remote remove gitee 2>/dev/null || true
          
          # Ê∑ªÂä†Êñ∞ÁöÑremote
          git remote add gitee "$GITEE_URL"
          
          echo "Testing connection..."
          if git ls-remote gitee --heads 2>/dev/null; then
            echo "‚úÖ Connection successful!"
            echo "Pushing to Gitee..."
            if git push gitee "$CURRENT_BRANCH" --force; then
              echo "‚úÖ Successfully pushed to Gitee!"
              exit 0
            else
              echo "‚ùå Push failed with Method 1"
            fi
          else
            echo "‚ùå Connection failed with Method 1"
          fi
          
          # ÊñπÊ≥ï2Ôºö‰ΩøÁî®username:tokenÊ†ºÂºè
          echo ""
          echo "Trying Method 2: username:token format..."
          # ËØ∑Â∞ÜYOUR_USERNAMEÊõøÊç¢‰∏∫ÊÇ®ÁöÑÂÆûÈôÖÁî®Êà∑Âêç
          GITEE_URL="https://liang:$GITEE_TOKEN@git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          git remote remove gitee 2>/dev/null || true
          git remote add gitee "$GITEE_URL"
          
          echo "Testing connection..."
          if git ls-remote gitee --heads 2>/dev/null; then
            echo "‚úÖ Connection successful!"
            echo "Pushing to Gitee..."
            if git push gitee "$CURRENT_BRANCH" --force; then
              echo "‚úÖ Successfully pushed to Gitee!"
              exit 0
            else
              echo "‚ùå Push failed with Method 2"
            fi
          else
            echo "‚ùå Connection failed with Method 2"
          fi
          
          # ÊñπÊ≥ï3Ôºö‰ΩøÁî®Git Credential Helper
          echo ""
          echo "Trying Method 3: Git Credential Helper..."
          
          # ÈÖçÁΩÆcredential helper
          git config --global credential.helper store
          
          # ÂàõÂª∫credentialÊñá‰ª∂
          CREDENTIAL_FILE="$HOME/.git-credentials"
          echo "https://liang:$GITEE_TOKEN@git.jrevea.cn:88" > "$CREDENTIAL_FILE"
          chmod 600 "$CREDENTIAL_FILE"
          
          GITEE_URL="https://git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          git remote remove gitee 2>/dev/null || true
          git remote add gitee "$GITEE_URL"
          
          echo "Testing connection..."
          if git ls-remote gitee --heads 2>/dev/null; then
            echo "‚úÖ Connection successful!"
            echo "Pushing to Gitee..."
            if git push gitee "$CURRENT_BRANCH" --force; then
              echo "‚úÖ Successfully pushed to Gitee!"
              exit 0
            else
              echo "‚ùå Push failed with Method 3"
            fi
          else
            echo "‚ùå Connection failed with Method 3"
          fi
          
          # Â¶ÇÊûúÊâÄÊúâÊñπÊ≥ïÈÉΩÂ§±Ë¥•
          echo ""
          echo "‚ùå All methods failed!"
          echo ""
          echo "üîç Troubleshooting steps:"
          echo "1. Verify the repository URL is correct:"
          echo "   https://git.jrevea.cn:88/liang/xiaomusic_github.git"
          echo "2. Check if port 88 is accessible from GitHub Actions"
          echo "3. Verify GITEE_TOKEN has write:repository permission"
          echo "4. Try accessing the repository manually:"
          echo "   git clone https://git.jrevea.cn:88/liang/xiaomusic_github.git"
          echo "5. Check Gitee logs for authentication errors"
          
          exit 1
      
      # 6. ÊÄªÁªì
      - name: Summary
        if: always()
        run: |
          echo "========================================"
          echo "üìä Workflow Summary"
          echo "========================================"
          echo "Time: $(date)"
          echo "GitHub Repo: https://github.com/Jrevealiang/xiaomusic"
          echo "Gitee Repo: https://git.jrevea.cn:88/liang/xiaomusic_github"
          echo "========================================"
