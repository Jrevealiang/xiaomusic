name: Sync upstream and push to Gitee

on:
  # 定时触发：每天UTC时间00:00（北京时间08:00）
  schedule:
    - cron: '0 0 * * *'
  
  # 手动触发
  workflow_dispatch:
  
  # 当有push到main分支时触发（可选）
  push:
    branches:
      - main
      - master

jobs:
  sync-and-push:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出GitHub仓库
      - name: Checkout GitHub repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. 配置Git用户信息
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      # 3. 同步上游仓库（原hanxi/xiaomusic）
      - name: Sync from upstream
        run: |
          # 添加上游仓库
          git remote add upstream https://github.com/hanxi/xiaomusic.git 2>/dev/null || true
          
          # 获取上游更新
          git fetch upstream
          
          # 切换到主分支
          CURRENT_BRANCH=$(git branch --show-current || echo "main")
          if [ "$CURRENT_BRANCH" = "" ]; then
            CURRENT_BRANCH="main"
          fi
          
          git checkout $CURRENT_BRANCH 2>/dev/null || git checkout -b $CURRENT_BRANCH
          
          # 合并上游更改
          if git show-ref --verify --quiet refs/remotes/upstream/$CURRENT_BRANCH; then
            git merge upstream/$CURRENT_BRANCH --no-edit
            
            # 检查冲突
            if git diff --name-only --diff-filter=U | grep -q .; then
              echo "Merge conflicts detected! Please resolve manually."
              exit 1
            fi
          fi
      
      # 4. 推送到GitHub（如果上游有更新）
      - name: Push to GitHub
        run: |
          # 检查是否有需要推送的更改
          if git status --porcelain | grep -q . || git log origin/$CURRENT_BRANCH..$CURRENT_BRANCH | grep -q .; then
            echo "Pushing changes to GitHub..."
            git push origin $CURRENT_BRANCH
          else
            echo "No changes to push to GitHub"
          fi
      
      # 5. 推送到Gitee
      - name: Push to Gitee
        run: |
          # 添加Gitee远程仓库
          git remote add gitee https://${{ secrets.GITEE_TOKEN }}@git.jrevea.cn:88/liang/xiaomusic_github.git 2>/dev/null || true
          
          # 更新Gitee远程URL（确保使用token）
          git remote set-url gitee https://${{ secrets.GITEE_TOKEN }}@git.jrevea.cn:88/liang/xiaomusic_github.git
          
          # 推送到Gitee
          echo "Pushing to Gitee..."
          git push gitee $CURRENT_BRANCH --force
          echo "Successfully pushed to Gitee"

