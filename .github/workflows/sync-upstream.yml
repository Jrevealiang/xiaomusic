name: Sync to Gitee via SSH on Port 88

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Sync from upstream
        run: |
          git remote add upstream https://github.com/hanxi/xiaomusic.git || true
          git fetch upstream
          git checkout main 2>/dev/null || git checkout master
          CURRENT_BRANCH=$(git branch --show-current)
          git merge upstream/$CURRENT_BRANCH --no-edit --strategy-option theirs || echo "Merge completed"
      
      - name: Push to GitHub
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          if ! git diff --quiet origin/$CURRENT_BRANCH; then
            git push origin $CURRENT_BRANCH
          fi
      
      - name: Setup SSH for Gitee Port 88
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "=== Setting up SSH for Gitee (Port 88) ==="
          
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "❌ SSH_PRIVATE_KEY is not set"
            exit 1
          fi
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # SSH over port 88 (如果Gitee支持SSH on port 88)
          cat > ~/.ssh/config << EOF
          Host git.jrevea.cn
            HostName git.jrevea.cn
            Port 88
            User git
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          
          chmod 600 ~/.ssh/config
          
          echo "Testing SSH connection on port 88..."
          ssh -T git@git.jrevea.cn 2>&1 | head -5 || echo "SSH test attempted"
      
      - name: Push to Gitee via SSH Port 88
        run: |
          echo "=== Pushing to Gitee via SSH (Port 88) ==="
          
          CURRENT_BRANCH=$(git branch --show-current)
          
          # 尝试SSH over port 88
          GITEE_SSH_URL="ssh://git@git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          git remote remove gitee-ssh 2>/dev/null || true
          git remote add gitee-ssh "$GITEE_SSH_URL"
          
          echo "Testing connection..."
          if timeout 30 git ls-remote gitee-ssh 2>&1; then
            echo "✅ SSH connection successful on port 88!"
            git push gitee-ssh "$CURRENT_BRANCH" --force && echo "✅ Push successful!"
          else
            echo "❌ SSH on port 88 failed, trying HTTPS..."
          fi
