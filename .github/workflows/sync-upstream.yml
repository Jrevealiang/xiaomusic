name: Sync to Gitee via HTTPS Port 88

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Configure Git for Port 88
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Á¶ÅÁî®SSLÈ™åËØÅÔºàÈíàÂØπËá™Á≠æÂêçËØÅ‰π¶Ôºâ
          git config http.sslVerify "false"
          
          # Â¢ûÂä†ÁºìÂÜ≤Âå∫Â§ßÂ∞è
          git config http.postBuffer 524288000
          
          echo "Git configuration:"
          git config --list | grep -E "http|ssl|user"
      
      - name: Network Test for Port 88
        run: |
          echo "=== Testing Port 88 Connectivity ==="
          
          echo "1. Testing DNS resolution..."
          nslookup git.jrevea.cn || dig git.jrevea.cn +short || echo "DNS test"
          
          echo ""
          echo "2. Testing port 88 connectivity..."
          timeout 10 nc -zv git.jrevea.cn 88 2>&1 || {
            echo "‚ùå Port 88 is not accessible"
            echo "This may be blocked by GitHub Actions network"
          }
          
          echo ""
          echo "3. Testing HTTPS on port 88..."
          timeout 15 curl -k -v -I "https://git.jrevea.cn:88/" 2>&1 | grep -E "(Connected|HTTP|SSL)" || {
            echo "‚ùå HTTPS on port 88 failed"
            echo "Possible issues:"
            echo "- Firewall blocking port 88"
            echo "- SSL certificate issues"
            echo "- Network restrictions"
          }
          
          echo ""
          echo "4. GitHub Actions IP address:"
          curl -s ifconfig.me || curl -s ipinfo.io/ip || echo "Unknown"
      
      - name: Sync from upstream
        run: |
          git remote add upstream https://github.com/hanxi/xiaomusic.git || true
          git fetch upstream
          git checkout main 2>/dev/null || git checkout master
          CURRENT_BRANCH=$(git branch --show-current)
          git merge upstream/$CURRENT_BRANCH --no-edit --strategy-option theirs || echo "Merge note"
      
      - name: Push to GitHub
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          if ! git diff --quiet origin/$CURRENT_BRANCH; then
            git push origin $CURRENT_BRANCH
          fi
      
      - name: Push to Gitee with Advanced HTTPS
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          echo "=== Pushing to Gitee via HTTPS Port 88 ==="
          
          if [ -z "$GITEE_TOKEN" ]; then
            echo "‚ùå GITEE_TOKEN is not set"
            echo "Please add GITEE_TOKEN to GitHub Secrets"
            exit 1
          fi
          
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Branch: $CURRENT_BRANCH"
          
          # ÊñπÊ≥ï1: Ê†áÂáÜHTTPS
          echo ""
          echo "üîß Method 1: Standard HTTPS"
          GITEE_URL="https://liang:$GITEE_TOKEN@git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          git remote remove gitee 2>/dev/null || true
          git remote add gitee "$GITEE_URL"
          
          echo "Testing connection..."
          if timeout 30 git ls-remote gitee 2>&1; then
            echo "‚úÖ Connection successful!"
            echo "Pushing changes..."
            git push gitee "$CURRENT_BRANCH" --force && {
              echo "‚úÖ Successfully pushed to Gitee!"
              exit 0
            }
          fi
          
          # ÊñπÊ≥ï2: ‰ΩøÁî®ÁéØÂ¢ÉÂèòÈáè
          echo ""
          echo "üîß Method 2: Using environment variables"
          export GIT_ASKPASS=/tmp/git-askpass.sh
          
          cat > /tmp/git-askpass.sh << 'EOF'
          #!/bin/bash
          echo "$GITEE_TOKEN"
          EOF
          chmod +x /tmp/git-askpass.sh
          
          git remote remove gitee2 2>/dev/null || true
          git remote add gitee2 "https://git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          echo "Testing with GIT_ASKPASS..."
          GIT_TERMINAL_PROMPT=0 timeout 30 git ls-remote gitee2 2>&1 && {
            echo "‚úÖ Connection successful!"
            git push gitee2 "$CURRENT_BRANCH" --force && {
              echo "‚úÖ Successfully pushed to Gitee!"
              exit 0
            }
          }
          
          # ÊñπÊ≥ï3: ‰ΩøÁî®credential helper
          echo ""
          echo "üîß Method 3: Using credential helper"
          git config credential.helper 'store --file .git-credentials'
          echo "https://liang:$GITEE_TOKEN@git.jrevea.cn:88" > .git-credentials
          
          git remote remove gitee3 2>/dev/null || true
          git remote add gitee3 "https://git.jrevea.cn:88/liang/xiaomusic_github.git"
          
          echo "Testing with credential helper..."
          timeout 30 git ls-remote gitee3 2>&1 && {
            echo "‚úÖ Connection successful!"
            git push gitee3 "$CURRENT_BRANCH" --force && {
              echo "‚úÖ Successfully pushed to Gitee!"
              exit 0
            }
          }
          
          echo ""
          echo "‚ùå All HTTPS methods failed"
          echo ""
          echo "üîç Diagnostic Information:"
          echo "Repository URL: https://git.jrevea.cn:88/liang/xiaomusic_github.git"
          echo "Port: 88"
          echo "Protocol: HTTPS"
          echo ""
          echo "üí° Possible Solutions:"
          echo "1. Check if port 88 is open to GitHub IP ranges"
          echo "2. Add GitHub Actions IP to Gitee firewall whitelist"
          echo "3. Configure Gitee to use standard ports (443 for HTTPS, 22 for SSH)"
          echo "4. Use a proxy server"
          
          exit 1
